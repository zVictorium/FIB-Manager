{% extends "base.html" %}

{% block title %}Search Results - FIB Manager{% endblock %}

{% block content %}
<section class="page-header">
    <h1 class="page-title">
        <span class="prompt">$</span> results
        <span class="cursor">█</span>
    </h1>
    <p class="page-desc">Found <strong>{{ total }}</strong> schedule combinations for <code>{{ subjects|join(', ') }}</code></p>
</section>

<section class="results-meta">
    <div class="meta-info">
        <span class="meta-item">
            <span class="meta-label">quad:</span>
            <span class="meta-value">{{ quad }}</span>
        </span>
        <span class="meta-item">
            <span class="meta-label">hours:</span>
            <span class="meta-value">{{ start_hour }}:00 - {{ end_hour }}:00</span>
        </span>
        <span class="meta-item">
            <span class="meta-label">total:</span>
            <span class="meta-value highlight">{{ total }}</span>
        </span>
    </div>
    <a href="{{ url_for('search') }}" class="btn btn-secondary">
        <span class="btn-icon">&lt;</span> New Search
    </a>
</section>

{% if schedules %}
<section class="schedules-section">
    <div class="schedules-list">
        {% for schedule in schedules %}
        <div class="schedule-card" data-index="{{ loop.index }}">
            <div class="schedule-header">
                <span class="schedule-number">#{{ loop.index }}</span>
                <span class="schedule-stats">
                    {% if schedule.dead_hours is defined %}
                    <span class="stat">
                        <span class="stat-label">dead hrs:</span>
                        <span class="stat-value">{{ schedule.dead_hours }}</span>
                    </span>
                    {% endif %}
                    {% if schedule.days is defined %}
                    <span class="stat">
                        <span class="stat-label">days:</span>
                        <span class="stat-value">{{ schedule.days }}</span>
                    </span>
                    {% endif %}
                </span>
            </div>
            
            <div class="schedule-subjects">
                {% for subject, info in schedule.subjects.items() %}
                <div class="schedule-subject">
                    <span class="subject-code">{{ subject }}</span>
                    <span class="subject-group">
                        G{{ info.group }}/{{ info.subgroup }}
                    </span>
                </div>
                {% endfor %}
            </div>
            
            <div class="schedule-actions">
                <button class="btn btn-primary btn-view-calendar" data-schedule-index="{{ loop.index0 }}">
                    View Calendar
                </button>
                {% if schedule.url %}
                <a href="{{ schedule.url }}" target="_blank" class="btn btn-link">
                    FIB <span class="external-icon">↗</span>
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Calendar Modal -->
<div id="calendar-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Schedule <span id="modal-schedule-number">#1</span></h3>
            <button class="modal-close" id="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="calendar-container">
                <table class="calendar-table">
                    <thead>
                        <tr>
                            <th class="calendar-hour-header">Hour</th>
                            <th>Mon</th>
                            <th>Tue</th>
                            <th>Wed</th>
                            <th>Thu</th>
                            <th>Fri</th>
                        </tr>
                    </thead>
                    <tbody id="calendar-body">
                        <!-- Generated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="calendar-legend" id="calendar-legend">
                <!-- Generated by JavaScript -->
            </div>
        </div>
    </div>
</div>

{% else %}
<section class="no-results-section">
    <div class="no-results">
        <span class="no-results-icon">∅</span>
        <h3>No schedules found</h3>
        <p>Try adjusting your search parameters:</p>
        <ul class="suggestions">
            <li>Extend the time range</li>
            <li>Increase max days</li>
            <li>Remove language restrictions</li>
            <li>Check subject codes</li>
        </ul>
        <a href="{{ url_for('search') }}" class="btn btn-primary">
            <span class="btn-icon">&lt;</span> Try Again
        </a>
    </div>
</section>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const schedulesData = {{ schedules_json|safe if schedules_json else '[]' }};
const startHour = {{ start_hour }};
const endHour = {{ end_hour }};

const subjectColors = [
    '#b71c1c', '#4a148c', '#1a237e', '#006064',
    '#1b5e20', '#e65100', '#3e2723', '#37474f'
];

function getSubjectColor(subject, subjects) {
    const index = subjects.indexOf(subject);
    return subjectColors[index % subjectColors.length];
}

function openCalendarModal(scheduleIndex) {
    const schedule = schedulesData[scheduleIndex];
    if (!schedule) return;
    
    const modal = document.getElementById('calendar-modal');
    const modalNumber = document.getElementById('modal-schedule-number');
    const calendarBody = document.getElementById('calendar-body');
    const legend = document.getElementById('calendar-legend');
    
    modalNumber.textContent = '#' + (scheduleIndex + 1);
    
    // Get all subjects in this schedule
    const subjects = Object.keys(schedule.subjects || {});
    
    // Build calendar grid
    let html = '';
    for (let hour = startHour; hour < endHour; hour++) {
        html += '<tr>';
        html += `<td class="calendar-hour">${hour}:00</td>`;
        
        for (let day = 1; day <= 5; day++) {
            const classes = (schedule.classes || []).filter(c => c.day === day && c.hour === hour);
            
            if (classes.length > 0) {
                const cls = classes[0];
                const color = getSubjectColor(cls.subject, subjects);
                html += `<td class="calendar-cell has-class" style="background-color: ${color};">`;
                html += `<span class="cell-subject">${cls.subject}</span>`;
                html += `<span class="cell-type">${cls.type}${cls.group}</span>`;
                html += '</td>';
            } else {
                html += '<td class="calendar-cell"></td>';
            }
        }
        html += '</tr>';
    }
    calendarBody.innerHTML = html;
    
    // Build legend
    let legendHtml = '';
    subjects.forEach((subject, index) => {
        const color = getSubjectColor(subject, subjects);
        const info = schedule.subjects[subject];
        legendHtml += `<div class="legend-item">`;
        legendHtml += `<span class="legend-color" style="background-color: ${color};"></span>`;
        legendHtml += `<span class="legend-text">${subject} (G${info.group}/${info.subgroup})</span>`;
        legendHtml += `</div>`;
    });
    legend.innerHTML = legendHtml;
    
    modal.classList.add('active');
}

function closeCalendarModal() {
    const modal = document.getElementById('calendar-modal');
    modal.classList.remove('active');
}

// Event listeners
document.querySelectorAll('.btn-view-calendar').forEach(btn => {
    btn.addEventListener('click', function() {
        const index = parseInt(this.dataset.scheduleIndex);
        openCalendarModal(index);
    });
});

document.getElementById('close-modal').addEventListener('click', closeCalendarModal);

document.getElementById('calendar-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCalendarModal();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCalendarModal();
    }
});
</script>
{% endblock %}
